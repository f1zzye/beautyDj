{%  extends 'partials/base.html' %}
{% load static %}
{% block content %}

<div class="l-inner" id="cart-list">
    {% if is_cart_empty %}
    <div class="woocommerce-notices-wrapper woocommerce-notices-wrapper--ajax" style="transform: translateY(0px);"></div>
    <div class="l-section l-section--container l-section--bottom-margin l-section--no-sidebar l-section--top-margin-60 l-section--white">
        <div class="l-section__content">
            <div class="woocommerce">
                <div class="c-cart-empty">
                    <h1 class="c-cart-empty__header">Кошик поки порожній</h1>
                    <a class="c-button c-button--outline c-cart-empty__backward" href="{% url 'core:product-list' %}">
                        Повернутись в магазин
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% else %}

    <div class="l-section l-section--container l-section--bottom-margin l-section--no-sidebar l-section--white l-section--top-margin">
        <div class="l-section__content">
            <div class="woocommerce">
                <div class="c-cart">
                    <div class="c-cart__wrap">
                        <div class="c-cart__col-1">
                            <div class=" js-sticky-sidebar-nearby ">

                                <form class="woocommerce-cart-form" id="cart-update-form" action="" method="post">
                                    <table class="shop_table shop_table_responsive cart woocommerce-cart-form__contents c-cart__shop-table" cellspacing="0">
                                        <thead class="c-cart__shop-thead">
                                            <tr>
                                                <th class="c-cart__shop-th c-cart__shop-th--product-name" colspan="2">Товар</th>
                                                <th class="c-cart__shop-th c-cart__shop-th--product-quantity">Кількість</th>
                                                <th class="c-cart__shop-th c-cart__shop-th--product-subtotal">Проміжний підсумок</th>
                                            </tr>
                                        </thead>
                                        <tbody class="c-cart__shop-tbody">
                                            <tr class="c-cart__shop-tr c-cart__shop-tr--space">
                                                <td colspan="4" class="c-cart__shop-td-space"></td>
                                            </tr>

                                            {% for product_id, item in cart_data.items %}
                                            <tr class="c-cart__shop-tr cart_item">

                                                <td class="c-cart__shop-td c-cart__shop-td--product-thumbnail">

                                                    <a class="c-cart__shop-remove remove delete-product" aria-label="Remove this item" data-product="{{ product_id }}">
                                                        <i class="ip-close-small c-cart__shop-remove-icon"></i>
                                                    </a>
                                                    <a class="c-cart__thumbnail-link" href="{% url 'core:product-detail' item.pid %}"><img decoding="async" width="115" height="115" src="{{ item.image }}" class="attachment-woocommerce_gallery_thumbnail size-woocommerce_gallery_thumbnail" alt="" srcset="{{ item.image }}" sizes="(max-width: 115px) 100vw, 115px"></a> </td>

                                                <td class="c-cart__shop-td c-cart__shop-td--product-name" data-title="Товар">
                                                    <a href="{% url 'core:product-detail' item.pid %}">{{ item.title }}</a>
                                                    {% if item.volume != 'None мл' %}
                                                    <div class="c-cart__shop-brand">Об`єм: {{ item.volume }}</div>
                                                    {% endif %}
                                                    <span class="c-cart__item-price">
                                                        <span class="woocommerce-Price-amount amount">
                                                            <bdi>
                                                                <span class="woocommerce-Price-currencySymbol">₴</span>
                                                                {{item.price}}
                                                            </bdi>
                                                        </span>
                                                    </span>
                                                </td>

                                                <td class="c-cart__shop-td c-cart__shop-td--product-quantity" data-title="Кількість">
                                                    <div class="c-product__quantity quantity">
                                                        <label class="screen-reader-text">{{ item.title }}</label>
                                                        <input type="number" class="c-product__quantity-value qty product-quantity-{{ product_id|slugify }}" min="1" value="{{ item.quantity }}" data-key="{{ product_id }}" readonly style="background-color: #fff;">
                                                        <button class="h-cb c-product__quantity-minus qty-minus" type="button" data-key="{{ product_id }}">
                                                            <i class="ip-minus"></i>
                                                        </button>
                                                        <button class="h-cb c-product__quantity-plus qty-plus" type="button" data-key="{{ product_id }}">
                                                            <i class="ip-plus_big"></i>
                                                        </button>
                                                    </div>
                                                </td>

                                                <td class="c-cart__shop-td c-cart__shop-td--product-price c-cart__shop-td--product-subtotal" data-title="Проміжний підсумок">
                                                    <span class="woocommerce-Price-amount amount">
                                                        <bdi>
                                                            <span class="woocommerce-Price-currencySymbol">₴</span>
                                                            {{ item.total_price|floatformat:2 }}
                                                        </bdi>
                                                    </span>
                                                </td>
                                            </tr>
                                            {% endfor %}

                                            <tr class="c-cart__shop-tr c-cart__shop-tr--space">
                                                <td colspan="4" class="c-cart__shop-td-space"></td>
                                            </tr>
                                            <tr class="c-cart__shop-tr c-cart__shop-tr--actions">
                                                <td colspan="5" class="c-cart__shop-td c-cart__shop-td--actions">
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </form>

                                <div class="l-section l-section--bottom-margin l-section--no-sidebar l-section--top-margin-60 l-section--checkout">
                                    <div class="l-section__content">
                                        <div class="woocommerce">

                                            <form action="{% url 'core:save_checkout_info' %}" method="POST">
                                                {% csrf_token %}

                                                <div class="c-cart__wrap">
                                                    <div class="c-cart__col-1 c-cart__col-1--checkout">
                                                        <div class=" js-sticky-sidebar-nearby ">


                                                            <div class="c-cart__customer-details" id="customer_details">
                                                                <div class="col-1">
                                                                    <div class="c-cart__form c-cart__form--billing-fields woocommerce-billing-fields">

                                                                        <h3 class="c-cart__header">Платіжні дані</h3>


                                                                        <div class="c-cart__billing-fields woocommerce-billing-fields__field-wrapper">
                                                                            <!--Ім'я-->
                                                                            <p class="form-row form-row-first validate-required" id="billing_first_name_field" data-priority="10">
                                                                                <label class="">Ім'я&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>
                                                                                <span class="woocommerce-input-wrapper">
                                                                                    <input type="text" class="input-text" name="fname" value="" placeholder="" autocomplete="given-name">
                                                                                </span>
                                                                            </p>
                                                                            <!--Прізвище-->
                                                                            <p class="form-row form-row-last validate-required" id="billing_last_name_field" data-priority="20">
                                                                                <label class="">Прізвище&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>
                                                                                <span class="woocommerce-input-wrapper">
                                                                                    <input type="text" class="input-text" name="lname" value="" placeholder="" autocomplete="family-name">
                                                                                </span>
                                                                            </p>
                                                                            <!--Адреса-->
<!--                                                                            <p class="form-row form-row-last validate-required" id="billing_address_field" data-priority="50">-->
<!--                                                                                <label class="">Адреса&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>-->
<!--                                                                                <span class="woocommerce-input-wrapper">-->
<!--                                                                                    <input type="text" class="input-text" name="address" value="" placeholder="Введіть адресу" autocomplete="street-address">-->
<!--                                                                                </span>-->
<!--                                                                            </p>-->
<!--                                                                            &lt;!&ndash;Країна&ndash;&gt;-->
                                                                            <p class="form-row form-row-last validate-required" data-priority="70">
                                                                                <label class="">Країна&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>
                                                                                <span class="woocommerce-input-wrapper">
                                                                                    <input type="text" class="input-text" name="country" value="" placeholder="Введіть країну" autocomplete="address-level2">
                                                                                </span>
                                                                            </p>
<!--                                                                            &lt;!&ndash;Місто&ndash;&gt;-->
<!--                                                                            <p class="form-row form-row-last validate-required" data-priority="70">-->
<!--                                                                                <label class="">Місто&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>-->
<!--                                                                                <span class="woocommerce-input-wrapper">-->
<!--                                                                                    <input type="text" class="input-text" name="city" value="" placeholder="Введіть місто" autocomplete="address-level2">-->
<!--                                                                                </span>-->
<!--                                                                            </p>-->
<!--                                                                            &lt;!&ndash;Область&ndash;&gt;-->
<!--                                                                            <p class="form-row form-row-last validate-required" id="billing_state_field" data-priority="80">-->
<!--                                                                                <label class="">Область&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>-->
<!--                                                                                <span class="woocommerce-input-wrapper">-->
<!--                                                                                    <input type="text" class="input-text" name="state" value="" placeholder="Введіть область" autocomplete="address-level1">-->
<!--                                                                                </span>-->
<!--                                                                            </p>-->
                                                                            <!--                                                <p class="form-row form-row-wide address-field update_totals_on_change validate-required" id="billing_country_field" data-priority="40"><label for="billing_country" class="">Країна / Регіон&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label><span class="woocommerce-input-wrapper"><strong>Україна</strong><input type="hidden" name="billing_country" id="billing_country" value="UA" autocomplete="country" class="country_to_state" readonly="readonly"></span></p>-->
                                                                            <!--                                                <p class="form-row address-field validate-required form-row-wide" id="billing_address_1_field" data-priority="50" style="display: none;"><label for="billing_address_1" class="">Назва вулиці&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label><span class="woocommerce-input-wrapper"><input type="text" class="input-text " name="billing_address_1" id="billing_address_1" placeholder="Номер будинку та назва вулиці" value="" autocomplete="address-line1" data-placeholder="Номер будинку та назва вулиці"></span></p>-->
                                                                            <!--                                                <p class="form-row address-field form-row-wide" id="billing_address_2_field" data-priority="60" style="display: none;"><label for="billing_address_2" class="screen-reader-text">Будинок, офіс, блок, тощо.&nbsp;<span class="optional">(необов'язково)</span></label><span class="woocommerce-input-wrapper"><input type="text" class="input-text " name="billing_address_2" id="billing_address_2" placeholder="Квартира, офіс, блок, тощо (опціонально)" value="" autocomplete="address-line2" data-placeholder="Квартира, офіс, блок, тощо (опціонально)"></span></p>-->
                                                                            <!--                                                <p class="form-row address-field validate-required form-row-wide" id="billing_city_field" data-priority="70" data-o_class="form-row form-row-wide address-field validate-required" style="display: none;"><label for="billing_city" class="">Місто / Село&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label><span class="woocommerce-input-wrapper"><input type="text" class="input-text " name="billing_city" id="billing_city" placeholder="" value="" autocomplete="address-level2"></span></p>-->
                                                                            <!--                                                <p class="form-row form-row-wide validate-required validate-phone" id="billing_phone_field" data-priority="100"><label for="billing_phone" class="">Телефон&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label><span class="woocommerce-input-wrapper"><input type="tel" class="input-text " name="billing_phone" id="billing_phone" placeholder="" value="+1 (826) 893-7648" autocomplete="tel"></span></p>-->

                                                                            <!--E-mail адреса-->
                                                                            <p class="form-row form-row-wide validate-required validate-email" data-priority="110">
                                                                                <label class="">E-mail адреса&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>
                                                                                <span class="woocommerce-input-wrapper">
                                                                                    <input type="email" value="" class="input-text" name="email" placeholder="" autocomplete="email username">
                                                                                </span>
                                                                            </p>

                                                                            <p class="form-row form-row-wide validate-required validate-email" data-priority="110">
                                                                                <label class="">Телефон&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>
                                                                                <span class="woocommerce-input-wrapper">
                                                                                    <input type="text" value="" class="input-text" name="phone" placeholder="" autocomplete="email username">
                                                                                </span>
                                                                            </p>
                                                                        </div>

                                                                        <div class="wcus-checkout-fields">
                                                                            <h3>Вкажіть адресу доставки</h3>
                                                                        </div>

                                                                        <div class="c-cart__billing-fields woocommerce-billing-fields__field-wrapper">
                                                                            <!-- Область -->
                                                                            <p class="form-row form-row-wide validate-required" id="region_field" data-priority="80">
                                                                                <label for="region">Оберіть область&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>
                                                                                <span class="woocommerce-input-wrapper">
                                                                                    <select id="region" name="state" value="" class="input-text" required>
                                                                                        <option value="">Завантаження...</option>
                                                                                    </select>
                                                                                </span>
                                                                            </p>

                                                                            <!-- Город -->
                                                                            <p class="form-row form-row-wide validate-required" id="city_field" data-priority="90">
                                                                                <label for="cityInput">Місто&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>
                                                                                <span class="woocommerce-input-wrapper city-search-container">
                                                                                    <div class="city-input-wrapper">
                                                                                        <input type="text"
                                                                                               id="cityInput"
                                                                                               class="input-text"
                                                                                               name="city"
                                                                                               value=""
                                                                                               placeholder="Введіть назву міста або оберіть зі списку"
                                                                                               autocomplete="off">
                                                                                        <button type="button"
                                                                                                id="toggleCitySelect"
                                                                                                style="display: none;">

                                                                                        </button>
                                                                                    </div>
                                                                                    <input type="hidden" id="cityRef" name="cityRef">
                                                                                    <div id="citySearchResults" class="search-results woocommerce-input-wrapper"></div>
                                                                                </span>
                                                                            </p>

                                                                            <!-- Отделение -->
                                                                            <p class="form-row form-row-wide validate-required" id="office_field" data-priority="100">
                                                                                <label for="office">Відділення&nbsp;<abbr class="required" title="обов'язкове">*</abbr></label>
                                                                                <span class="woocommerce-input-wrapper">
                                                                                    <select id="office" name="address" value="" class="input-text" required>
                                                                                        <option value="">Оберіть відділення</option>
                                                                                    </select>
                                                                                </span>
                                                                            </p>
                                                                        </div>

                                                                    </div>
                                                                </div>

                                                                <div class="col-2">
                                                                    <div class="c-cart__form c-cart__form--shipping-fields woocommerce-shipping-fields">


                                                                    </div>
                                                                    <div class="c-cart__form c-cart__form--additional-fields woocommerce-additional-fields">



                                                                        <div class="c-cart__additional-fields woocommerce-additional-fields__field-wrapper">
                                                                            <p class="form-row notes" id="order_comments_field" data-priority="">
                                                                                <label class="">Нотатки до замовлення&nbsp;<span class="optional">(необов'язково)</span></label>
                                                                                <span class="woocommerce-input-wrapper">
                                                                                    <textarea name="extra_info" value="" class="input-text " placeholder="Нотатки до вашого замовлення, наприклад спеціальні нотатки для доставки." rows="2" cols="5"></textarea>
                                                                                </span>
                                                                            </p>
                                                                        </div>

                                                                        <button type="submit" class="c-button c-button--big c-cart__checkout-btn checkout-button button alt wc-forward">
                                                                            Оформлення замовлення
                                                                        </button>


                                                                    </div>
                                                                </div>
                                                            </div>


                                                        </div>
                                                    </div>
                                                </div>

                                            </form>

                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>


                        <div class="c-cart__col-2">


                            <div class="cart-collaterals c-cart__collaterals js-sticky-sidebar">
                                <div class="c-cart__totals cart_totals">


                                    <div class="c-cart__coupon">

                                        <a href="#" class="js-cart-coupon">
                                            <div class="c-cart__coupon-header">
                                                Код купону <i class="ip-down_arrow c-cart__select-icon"></i>
                                            </div>
                                        </a>

                                        <div class="c-cart__coupon-from-wrap">
                                            <div class="c-cart__coupon-form">
                                                <input type="text" name="coupon_code" class="input-text" id="coupon_code" value="" placeholder="Код купону">
                                                <button class="c-button--outline c-cart__coupon-apply c-button" id="ip-checkout-apply-coupon" name="apply_coupon" type="button">Прийняти</button>
                                            </div>
                                        </div>

                                    </div>
                                    <table class="c-cart__totals-table shop_table">

                                        <tbody>
                                            <tr class="c-cart__totals-subtotal cart-subtotal">
                                                <th class="c-cart__sub-sub-header">Проміжний підсумок</th>
                                                <td class="c-cart__totals-price" data-title="Проміжний підсумок"><span class="woocommerce-Price-amount amount"><bdi><span class="woocommerce-Price-currencySymbol">₴</span>{{cart_total|floatformat:2}}</bdi></span></td>
                                            </tr>


                                            <tr>
                                                <td colspan="2" class="c-cart__totals-space c-cart__totals-space--hr"></td>
                                            </tr>


                                            <tr class="woocommerce-shipping-totals shipping">
                                                <td class="c-cart__totals-td" data-title="Доставка" colspan="2">
                                                    <div class="c-cart__sub-header">Доставка</div>
                                                    <ul id="shipping_method" class="c-cart__shipping-methods woocommerce-shipping-methods">
                                                        <li class="c-cart__shipping-methods-item">
                                                            <span class="c-cart__shipping-methods-wrap"><input type="radio" name="shipping_method[0]" data-index="0" id="shipping_method_0_nova_poshta_shipping1" value="nova_poshta_shipping:1" class="shipping_method" checked="checked"></span><label class="c-cart__shipping-methods-label" for="shipping_method_0_nova_poshta_shipping1"><span id="wcus-shipping-cost">Нова Пошта</span></label><input id="wcus-shipping-name" type="hidden" value="Нова Пошта"> </li>
                                                    </ul>

                                                </td>
                                            </tr>


                                            <tr>
                                                <td colspan="2" class="c-cart__totals-space c-cart__totals-space--hr"></td>
                                            </tr>

                                            <tr class="order-total">
                                                <th class="c-cart__sub-sub-header">Загалом</th>
                                                <td class="c-cart__totals-price c-cart__totals-price--total" data-title="Загалом"><span id="wcus-order-total"><strong><span class="woocommerce-Price-amount amount"><bdi><span class="woocommerce-Price-currencySymbol">₴</span>{{cart_total|floatformat:2}}</bdi></span></strong> </span></td>
                                            </tr>


                                            <tr>
                                                <td class="c-cart__totals-action wc-proceed-to-checkout" colspan="2">

                                                    <!--                                                    <button type="submit" class="c-button c-button&#45;&#45;big c-cart__checkout-btn checkout-button button alt wc-forward">-->
                                                    <!--                                                        Оформлення замовлення-->
                                                    <!--                                                    </button>-->
                                                </td>
                                            </tr>

                                        </tbody>
                                    </table>



                                </div>
                            </div>
                        </div>
                    </div>

                </div>


                <div class="c-cart__cross-sell">
                </div>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener('DOMContentLoaded', function () {
    // Кэшируем DOM элементы
    const elements = {
        region: document.getElementById("region"),
        city: {
            input: document.getElementById("cityInput"),
            results: document.getElementById("citySearchResults"),
            toggle: document.getElementById("toggleCitySelect"),
            ref: document.getElementById("cityRef")
        },
        office: document.getElementById("office")
    };

    // Константы
    const API_KEY = "3506f7c429e7bd9d4bd22481c0458455";
    const DEFAULT_OPTIONS = {
        loading: '<option value="">Завантаження...</option>',
        select: '<option value="">Оберіть відділення</option>'
    };

    // Класс для работы с API
    class NovaPoshtaApi {
        constructor(apiKey) {
            this.apiKey = apiKey;
            this.baseUrl = "https://api.novaposhta.ua/v2.0/json/";
        }

        async request(modelName, calledMethod, methodProperties = {}) {
            try {
                const response = await fetch(this.baseUrl, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        apiKey: this.apiKey,
                        modelName,
                        calledMethod,
                        methodProperties
                    })
                });
                const data = await response.json();
                if (!data.success) throw new Error(data.errors?.join(' ') || "API request failed");
                return data;
            } catch (error) {
                console.error(`${modelName}/${calledMethod} failed:`, error);
                throw error;
            }
        }
    }

    const api = new NovaPoshtaApi(API_KEY);
    let citiesData = [];

    // Утилиты
    const utils = {
        setLoading: (isLoading) => {
            elements.city.input.disabled = isLoading;
            elements.city.input.placeholder = isLoading ?
                'Завантаження...' :
                'Введіть назву міста або оберіть зі списку';
        },

        sortByLocale: (a, b, field = 'Description') =>
            a[field].localeCompare(b[field], 'uk'),

        getCityName: (city) => city.Description.split(',')[0].trim().toLowerCase()
    };

    // Функция выбора города
    function selectCity(city) {
        elements.city.input.value = city.Description;
        elements.city.ref.value = city.Ref;
        elements.city.results.style.display = 'none';
        loadOffices(city.Ref);
    }

    // Основные функции
    async function loadRegions() {
        try {
            elements.region.innerHTML = DEFAULT_OPTIONS.loading;
            utils.setLoading(true);
            elements.office.innerHTML = DEFAULT_OPTIONS.select;

            const response = await api.request("Address", "getAreas");
            const filteredAreas = response.data
                .filter(area => area.Description !== 'АРК')
                .sort(utils.sortByLocale);

            elements.region.innerHTML = '<option value="">Оберіть область</option>' +
                filteredAreas.map(area =>
                    `<option value="${area.Ref}">${area.Description}</option>`
                ).join('');

        } catch (error) {
            elements.region.innerHTML = '<option value="">Помилка завантаження</option>';
        }
    }

    async function loadCities(regionRef) {
        try {
            utils.setLoading(true);
            elements.office.innerHTML = DEFAULT_OPTIONS.select;

            const response = await api.request("Address", "getCities", { AreaRef: regionRef });
            citiesData = response.data.sort(utils.sortByLocale);
            utils.setLoading(false);

        } catch (error) {
            utils.setLoading(true);
            elements.city.input.placeholder = 'Помилка завантаження';
        }
    }

    function filterCities(searchText) {
        if (!searchText) {
            displaySearchResults(citiesData);
            return;
        }

        const search = searchText.toLowerCase().trim();
        const filtered = citiesData
            .filter(city => utils.getCityName(city).includes(search))
            .sort((a, b) => {
                const nameA = utils.getCityName(a);
                const nameB = utils.getCityName(b);
                const aStarts = nameA.startsWith(search);
                const bStarts = nameB.startsWith(search);

                return aStarts === bStarts ?
                    nameA.localeCompare(nameB, 'uk') :
                    bStarts ? -1 : 1;
            });

        displaySearchResults(filtered);
    }

    function displaySearchResults(cities) {
        elements.city.results.innerHTML = '';

        if (cities.length) {
            cities.forEach(city => {
                const div = document.createElement('div');
                div.className = 'dropdown-item';
                div.textContent = city.Description;
                div.onclick = () => selectCity(city);
                elements.city.results.appendChild(div);
            });
            elements.city.results.style.display = 'block';
        } else {
            elements.city.results.style.display = 'none';
        }
    }

    async function loadOffices(cityRef) {
        try {
            elements.office.innerHTML = DEFAULT_OPTIONS.loading;

            const response = await api.request("Address", "getWarehouses", { CityRef: cityRef });
            const sortedOffices = response.data.sort((a, b) =>
                parseInt(a.Number) - parseInt(b.Number)
            );

            elements.office.innerHTML = DEFAULT_OPTIONS.select +
                sortedOffices.map(office =>
                    `<option value="${office.Ref}">${office.Description}</option>`
                ).join('');

        } catch (error) {
            elements.office.innerHTML = '<option value="">Помилка завантаження</option>';
        }
    }

    // Event Listeners
    elements.region.addEventListener("change", (e) => {
        const regionRef = e.target.value;
        elements.city.input.value = '';
        elements.city.results.style.display = 'none';

        if (regionRef) {
            loadCities(regionRef);
        } else {
            utils.setLoading(true);
            elements.office.innerHTML = DEFAULT_OPTIONS.select;
        }
    });

    elements.city.input.addEventListener('input', (e) => filterCities(e.target.value));

    elements.city.input.addEventListener('focus', () => {
        if (elements.region.value) {
            displaySearchResults(citiesData);
        }
    });

    document.addEventListener('click', (e) => {
        if (!elements.city.input.contains(e.target) &&
            !elements.city.results.contains(e.target)) {
            elements.city.results.style.display = 'none';
        }
    });

    // Initialize
    loadRegions();
});

</script>

    <style>
       /* Основные стили для контейнеров */
.city-search-container {
    position: relative;
    width: 100%;
}

.city-input-wrapper {
    position: relative;
    width: 100%;
}

/* Стили для инпутов и селектов */
.woocommerce-input-wrapper select,
.woocommerce-input-wrapper input,
.city-input-wrapper input {
    width: 100%;
    padding: 12px 15px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    font-size: 14px;
    line-height: 1.5;
    color: #333;
    background-color: #fff;
    transition: all 0.3s ease;
    box-sizing: border-box;
    height: 45px;
    margin: 0;
}

/* Стили для select */
select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 15px center;
    background-size: 16px;
    padding-right: 45px;
}

/* Стили для результатов поиска */
.search-results {
    position: absolute;
    left: 0;
    right: 0;
    width: 100%;
    max-height: 250px;
    overflow-y: auto;
    background: white;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    margin-top: 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.08);
    display: none;
    z-index: 1000;
    box-sizing: border-box;
}

/* Элементы списка */
.search-results div,
.dropdown-item {
    padding: 12px 15px;
    cursor: pointer;
    transition: background-color 0.2s ease;
    border-bottom: 1px solid #f5f5f5;
}

.search-results div:last-child,
.dropdown-item:last-child {
    border-bottom: none;
}

.search-results div:hover,
.dropdown-item:hover {
    background-color: #f8f8f8;
}

/* Состояния элементов */
.woocommerce-input-wrapper select:hover,
.woocommerce-input-wrapper input:hover,
.city-input-wrapper input:hover {
    border-color: #bdbdbd;
}

.woocommerce-input-wrapper select:focus,
.woocommerce-input-wrapper input:focus,
.city-input-wrapper input:focus {
    border-color: #666;
    outline: none;
    box-shadow: 0 0 0 2px rgba(0, 0, 0, 0.05);
}

/* Стили для disabled состояния */
.woocommerce-input-wrapper select:disabled,
.woocommerce-input-wrapper input:disabled,
.city-input-wrapper input:disabled {
    background-color: #f9f9f9;
    border-color: #e0e0e0;
    color: #999;
    cursor: not-allowed;
}

/* Стили для скроллбара */
.search-results::-webkit-scrollbar {
    width: 6px;
}

.search-results::-webkit-scrollbar-track {
    background: #f5f5f5;
    border-radius: 3px;
}

.search-results::-webkit-scrollbar-thumb {
    background: #ddd;
    border-radius: 3px;
}

.search-results::-webkit-scrollbar-thumb:hover {
    background: #c4c4c4;
}

/* Анимации */
@keyframes fadeIn {
    from {
        opacity: 0;
        transform: translateY(-10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.search-results.show {
    display: block;
    animation: fadeIn 0.2s ease-out;
}

/* Медиа-запросы для мобильных устройств */
@media screen and (max-width: 768px) {
    /* Стили для select и его выпадающего списка */
    select#office {
        font-size: 16px;
        padding: 10px 12px;
        height: 42px;
        background-position: right 12px center;
    }

    /* Мобильная оптимизация для выпадающих списков */
    .search-results,
    select#office option {
        max-height: 60vh; /* 60% высоты экрана */
        font-size: 16px;
        -webkit-overflow-scrolling: touch;
    }

    /* Улучшенная читаемость для мобильных */
    .search-results div,
    .dropdown-item,
    select#office option {
        padding: 14px 15px;
        min-height: 44px; /* Минимальная высота для удобного тапа */
        display: flex;
        align-items: center;
    }

    /* Оптимизация для iOS */
    @supports (-webkit-touch-callout: none) {
        select#office {
            padding-right: 30px;
        }

        .search-results,
        select#office option {
            -webkit-overflow-scrolling: touch;
        }
    }

    /* Улучшение производительности */
    .search-results,
    select#office {
        -webkit-tap-highlight-color: transparent;
        transform: translateZ(0);
    }
}

/* Дополнительные оптимизации для маленьких экранов */
@media screen and (max-width: 480px) {
    .woocommerce-input-wrapper select,
    .woocommerce-input-wrapper input,
    .city-input-wrapper input {
        font-size: 16px;
        height: 42px;
        padding: 8px 12px;
    }

    .search-results {
        max-height: 50vh; /* 50% высоты экрана для очень маленьких устройств */
    }

    .search-results div {
        padding: 12px 15px;
    }

    /* Оптимизация для маленьких экранов */
    select#office,
    .search-results {
        font-size: 16px;
        line-height: 1.3;
    }

    /* Увеличенная область нажатия */
    select#office option,
    .search-results div {
        min-height: 48px;
    }
}

/* Фиксы для темного режима */
@media (prefers-color-scheme: dark) {
    select#office,
    .search-results {
        background-color: #fff;
    }
}

/* Улучшение доступности */
@media (hover: none) {
    .search-results div:hover,
    .dropdown-item:hover {
        background-color: transparent;
    }

    .search-results div:active,
    .dropdown-item:active {
        background-color: #f0f0f0;
    }
}
    </style>

    {% endif %}
</div>

{% endblock %}